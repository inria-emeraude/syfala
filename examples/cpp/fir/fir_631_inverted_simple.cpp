
#include <algorithm>
#include <cmath>
#include <inttypes.h>
#include <string.h>
#include <hls_stream.h>
#include <syfala/utilities.hpp>

#define INPUTS 0
#define OUTPUTS 2

static bool initialization = true;

static inline float ioreadf(sy_ap_int const& input) {
    return input.to_float() * SCALE_FACTOR;
}

static inline void iowritef(float f, sy_ap_int* output) {
    *output = sy_ap_int(f * SCALE_FACTOR);
}

#define N 621

static float coeffs[N] = {
 0.000000004902472751,
    0.000000008024683807,
    0.000000009434599048,
    0.000000009220272350,
    0.000000007490016136,
    0.000000004372760126,
    0.000000000018556638,
    -0.000000005400824845,
    -0.000000011691283216,
    -0.000000018635833058,
    -0.000000025994203144,
    -0.000000033502683005,
    -0.000000040874316645,
    -0.000000047799543627,
    -0.000000053947383282,
    -0.000000058967252179,
    -0.000000062491493692,
    -0.000000064138685988,
    -0.000000063517776789,
    -0.000000060233074760,
    -0.000000053890104089,
    -0.000000044102305523,
    -0.000000030498540107,
    -0.000000012731325991,
    0.000000009514289673,
    0.000000036511347712,
    0.000000068481234062,
    0.000000105583751630,
    0.000000147907204510,
    0.000000195458710275,
    0.000000248154972525,
    0.000000305813755896,
    0.000000368146313118,
    0.000000434751013783,
    0.000000505108421317,
    0.000000578578053247,
    0.000000654397044920,
    0.000000731680913785,
    0.000000809426594850,
    0.000000886517883522,
    0.000000961733384911,
    0.000001033757024641,
    0.000001101191130658,
    0.000001162572044330,
    0.000001216388167894,
    0.000001261100300472,
    0.000001295164062021,
    0.000001317054149865,
    0.000001325290122046,
    0.000001318463351778,
    0.000001295264753816,
    0.000001254512842735,
    0.000001195181650628,
    0.000001116428004293,
    0.000001017617644509,
    0.000000898349659186,
    0.000000758478702477,
    0.000000598134480254,
    0.000000417738002645,
    0.000000218014132607,
    0.000000000000000020,
    -0.000000234951100827,
    -0.000000485170652773,
    -0.000000748680952391,
    -0.000001023206421190,
    -0.000001306190289852,
    -0.000001594816664612,
    -0.000001886037893710,
    -0.000002176607055183,
    -0.000002463115291634,
    -0.000002742033619676,
    -0.000003009758748279,
    -0.000003262662348117,
    -0.000003497143129455,
    -0.000003709681006284,
    -0.000003896892555977,
    -0.000004055586922940,
    -0.000004182821268190,
    -0.000004275954830782,
    -0.000004332700647581,
    -0.000004351173971221,
    -0.000004329936437281,
    -0.000004268035056938,
    -0.000004165035155166,
    -0.000004021046432619,
    -0.000003836741405366,
    -0.000003613365565979,
    -0.000003352738715547,
    -0.000003057247033460,
    -0.000002729825583223,
    -0.000002373931092039,
    -0.000001993504992360,
    -0.000001592926868244,
    -0.000001176958610458,
    -0.000000750679745239,
    -0.000000319414564304,
    0.000000111348158614,
    0.000000536041925124,
    0.000000949114659725,
    0.000001345125027795,
    0.000001718841583200,
    0.000002065343296662,
    0.000002380119927087,
    0.000002659170626109,
    0.000002899099116816,
    0.000003097203758372,
    0.000003251560804530,
    0.000003361099181840,
    0.000003425665158082,
    0.000003446075338796,
    0.000003424156523693,
    0.000003362771070633,
    0.000003265826556083,
    0.000003138268681962,
    0.000002986056562799,
    0.000002816119727276,
    0.000002636296387403,
    0.000002455252759921,
    0.000002282383469571,
    0.000002127693315939,
    0.000002001660945469,
    0.000001915085231192,
    0.000001878915425650,
    0.000001904066409537,
    0.000002001220611467,
    0.000002180618415117,
    0.000002451839100076,
    0.000002823574574900,
    0.000003303398356216,
    0.000003897532419795,
    0.000004610614699867,
    0.000005445470134967,
    0.000006402888254863,
    0.000007481410367676,
    0.000008677129442015,
    0.000009983505780413,
    0.000011391201551415,
    0.000012887937183302,
    0.000014458372527630,
    0.000016084015570403,
    0.000017743161308839,
    0.000019410863218295,
    0.000021058939512850,
    0.000022656016151430,
    0.000024167608265218,
    0.000025556241379450,
    0.000026781613480034,
    0.000027800798630689,
    0.000028568492486713,
    0.000029037299675564,
    0.000029158062629308,
    0.000028880231058232,
    0.000028152270856293,
    0.000026922110825936,
    0.000025137625210369,
    0.000119481415591804,
    0.000099593312537162,
    0.000077612835072041,
    0.000053620940497451,
    0.000027712453426058,
    0.000000000000000009,
    -0.000029381938904081,
    -0.000060273050565706,
    -0.000092483492115664,
    -0.000125790675192444,
    -0.000159936732776646,
    -0.000194626856040742,
    -0.000229528671357562,
    -0.000264272803888058,
    -0.000298454744878031,
    -0.000331638105544339,
    -0.000363359301990235,
    -0.000393133673844755,
    -0.000420462995283681,
    -0.000444844291851262,
    -0.000465779831232075,
    -0.000482788112019353,
    -0.000495415632810990,
    -0.000503249185830466,
    -0.000505928385874907,
    -0.000503158117806774,
    -0.000494720565007959,
    -0.000480486468041741,
    -0.000460425257913914,
    -0.000434613712296391,
    -0.000403242796200816,
    -0.000366622370973810,
    -0.000325183487032667,
    -0.000279478016141098,
    -0.000230175427699775,
    -0.000178056569730514,
    -0.000124004378004403,
    -0.000068991504941377,
    -0.000014064932167171,
    0.000039672294526274,
    0.000091081993200971,
    0.000139014146963978,
    0.000182332215737046,
    0.000219940027397075,
    0.000250809754362892,
    0.000274010426562442,
    0.000288736385722866,
    0.000294335050527215,
    0.000290333338644163,
    0.000276462081028315,
    0.000252677767038734,
    0.000219180976404838,
    0.000176430886170439,
    0.000125155287463275,
    0.000066355607952302,
    0.000001306510545524,
    -0.000068450273691002,
    -0.000141118121478442,
    -0.000214663836304227,
    -0.000286842127486260,
    -0.000355226143077886,
    -0.000417243823114014,
    -0.000470219710877282,
    -0.000511421731979161,
    -0.000538112326697508,
    -0.000547603202793571,
    -0.000537312866543427,
    -0.000504825991463631,
    -0.000447953599579284,
    -0.000364792961266736,
    -0.000253786068685736,
    -0.000113775506283524,
    0.000055943468799766,
    0.000255575812353440,
    0.000484785686882496,
    0.000742662649125180,
    0.001027696037701160,
    0.001337758466156856,
    0.001670099204623520,
    0.002021348091831965,
    0.002387530460221957,
    0.002764093382642050,
    0.003145943362291211,
    0.003527495391074989,
    0.003902733098661712,
    0.004265279508682179,
    0.004608477713326713,
    0.004925480576764475,
    0.005209348385081043,
    0.005453153179503427,
    0.005650088344157858,
    0.005793581872905044,
    0.005877411615111470,
    0.005895820700416213,
    0.005843631270165781,
    0.005716354600302972,
    0.005510295688752121,
    0.005222650400855701,
    0.004851593319783244,
    0.004396354535065301,
    0.003857283720962701,
    0.003235900006123959,
    0.002534926315220075,
    0.001758307069713034,
    0.000911208365839424,
    0.000000000000000008,
    -0.000967781018664427,
    -0.001983485545755804,
    -0.003037425754457219,
    -0.004118966452765009,
    -0.005216633458421592,
    -0.006318237934574976,
    -0.007411015309307097,
    -0.008481777137534341,
    -0.009517074019103738,
    -0.010503367466621609,
    -0.011427208424806257,
    -0.012275419983650858,
    -0.013035281703693887,
    -0.013694712885903591,
    -0.014242452073247553,
    -0.014668230067385463,
    -0.014962933782942339,
    -0.015118758343572588,
    -0.015129344947960841,
    -0.014989902198690935,
    -0.014697308790595345,
    -0.014250195695078724,
    -0.013649006249734582,
    -0.012896032864430721,
    -0.011995429381549121,
    -0.010953198474342261,
    -0.009777153828179543,
    -0.008476857219243895,
    -0.007063530978250420,
    -0.005549946697122915,
    -0.003950291398384809,
    -0.002280012734498934,
    -0.000555645111872491,
    0.001205381063601297,
    0.002984944550803042,
    0.004764450141860270,
    0.006525054331259552,
    0.008247896726328741,
    0.009914334029262659,
    0.011506173357404635,
    0.013005901653535563,
    0.014396907971888263,
    0.015663695508363343,
    0.016792080373811406,
    0.017769374285588137,
    0.018584548572188248,
    0.019228377145522196,
    0.019693556391244562,
    0.019974800255131611,
    0.020068909157659749,
    0.019974800255131896,
    0.019693556391244628,
    0.019228377145522044,
    0.018584548572188251,
    0.017769374285588242,
    0.016792080373811309,
    0.015663695508363072,
    0.014396907971888223,
    0.013005901653535754,
    0.011506173357404652,
    0.009914334029262509,
    0.008247896726328712,
    0.006525054331259617,
    0.004764450141860227,
    0.002984944550802891,
    0.001205381063601275,
    -0.000555645111872396,
    -0.002280012734498911,
    -0.003950291398384860,
    -0.005549946697122917,
    -0.007063530978250394,
    -0.008476857219243886,
    -0.009777153828179553,
    -0.010953198474342252,
    -0.011995429381549112,
    -0.012896032864430706,
    -0.013649006249734556,
    -0.014250195695078703,
    -0.014697308790595345,
    -0.014989902198690896,
    -0.015129344947960768,
    -0.015118758343572571,
    -0.014962933782942379,
    -0.014668230067385452,
    -0.014242452073247496,
    -0.013694712885903570,
    -0.013035281703693896,
    -0.012275419983650820,
    -0.011427208424806179,
    -0.010503367466621592,
    -0.009517074019103771,
    -0.008481777137534332,
    -0.007411015309307056,
    -0.006318237934574959,
    -0.005216633458421594,
    -0.004118966452764990,
    -0.003037425754457190,
    -0.001983485545755799,
    -0.000967781018664438,
    0.000000000000000005,
    0.000911208365839423,
    0.001758307069713033,
    0.002534926315220073,
    0.003235900006123951,
    0.003857283720962698,
    0.004396354535065305,
    0.004851593319783264,
    0.005222650400855713,
    0.005510295688752118,
    0.005716354600302975,
    0.005843631270165791,
    0.005895820700416215,
    0.005877411615111459,
    0.005793581872905044,
    0.005650088344157872,
    0.005453153179503429,
    0.005209348385081034,
    0.004925480576764476,
    0.004608477713326716,
    0.004265279508682178,
    0.003902733098661709,
    0.003527495391074986,
    0.003145943362291207,
    0.002764093382642044,
    0.002387530460221954,
    0.002021348091831958,
    0.001670099204623508,
    0.001337758466156856,
    0.001027696037701169,
    0.000742662649125172,
    0.000484785686882475,
    0.000255575812353432,
    0.000055943468799772,
    -0.000113775506283528,
    -0.000253786068685752,
    -0.000364792961266734,
    -0.000447953599579268,
    -0.000504825991463634,
    -0.000537312866543448,
    -0.000547603202793577,
    -0.000538112326697499,
    -0.000511421731979161,
    -0.000470219710877292,
    -0.000417243823114011,
    -0.000355226143077874,
    -0.000286842127486263,
    -0.000214663836304238,
    -0.000141118121478444,
    -0.000068450273690997,
    0.000001306510545523,
    0.000066355607952297,
    0.000125155287463276,
    0.000176430886170444,
    0.000219180976404836,
    0.000252677767038731,
    0.000276462081028316,
    0.000290333338644166,
    0.000294335050527215,
    0.000288736385722863,
    0.000274010426562444,
    0.000250809754362894,
    0.000219940027397074,
    0.000182332215737044,
    0.000139014146963976,
    0.000091081993200971,
    0.000039672294526275,
    -0.000014064932167175,
    -0.000068991504941376,
    -0.000124004378004404,
    -0.000178056569730517,
    -0.000230175427699781,
    -0.000279478016141102,
    -0.000325183487032671,
    -0.000366622370973814,
    -0.000403242796200823,
    -0.000434613712296390,
    -0.000460425257913910,
    -0.000480486468041744,
    -0.000494720565007969,
    -0.000503158117806780,
    -0.000505928385874907,
    -0.000503249185830470,
    -0.000495415632810993,
    -0.000482788112019352,
    -0.000465779831232070,
    -0.000444844291851263,
    -0.000420462995283690,
    -0.000393133673844758,
    -0.000363359301990233,
    -0.000331638105544341,
    -0.000298454744878036,
    -0.000264272803888055,
    -0.000229528671357555,
    -0.000194626856040743,
    -0.000159936732776652,
    -0.000125790675192445,
    -0.000092483492115659,
    -0.000060273050565704,
    -0.000029381938904081,
    0.000000000000000014,
    0.000027712453426069,
    0.000053620940497455,
    0.000077612835072038,
    0.000099593312537166,
    0.000119481415591813,
    0.000025137625210376,
    0.000026922110825940,
    0.000028152270856300,
    0.000028880231058247,
    0.000029158062629312,
    0.000029037299675562,
    0.000028568492486717,
    0.000027800798630699,
    0.000026781613480039,
    0.000025556241379451,
    0.000024167608265225,
    0.000022656016151444,
    0.000021058939512856,
    0.000019410863218294,
    0.000017743161308844,
    0.000016084015570412,
    0.000014458372527634,
    0.000012887937183301,
    0.000011391201551419,
    0.000009983505780423,
    0.000008677129442016,
    0.000007481410367670,
    0.000006402888254863,
    0.000005445470134972,
    0.000004610614699865,
    0.000003897532419790,
    0.000003303398356219,
    0.000002823574574909,
    0.000002451839100078,
    0.000002180618415112,
    0.000002001220611469,
    0.000001904066409543,
    0.000001878915425654,
    0.000001915085231194,
    0.000002001660945475,
    0.000002127693315951,
    0.000002282383469577,
    0.000002455252759921,
    0.000002636296387409,
    0.000002816119727285,
    0.000002986056562805,
    0.000003138268681966,
    0.000003265826556093,
    0.000003362771070648,
    0.000003424156523700,
    0.000003446075338797,
    0.000003425665158076,
    0.000003361099181839,
    0.000003251560804527,
    0.000003097203758367,
    0.000002899099116817,
    0.000002659170626117,
    0.000002380119927088,
    0.000002065343296657,
    0.000001718841583202,
    0.000001345125027800,
    0.000000949114659729,
    0.000000536041925124,
    0.000000111348158620,
    -0.000000319414564292,
    -0.000000750679745234,
    -0.000001176958610458,
    -0.000001592926868237,
    -0.000001993504992351,
    -0.000002373931092032,
    -0.000002729825583219,
    -0.000003057247033451,
    -0.000003352738715533,
    -0.000003613365565974,
    -0.000003836741405367,
    -0.000004021046432615,
    -0.000004165035155157,
    -0.000004268035056935,
    -0.000004329936437281,
    -0.000004351173971215,
    -0.000004332700647571,
    -0.000004275954830780,
    -0.000004182821268195,
    -0.000004055586922939,
    -0.000003896892555970,
    -0.000003709681006284,
    -0.000003497143129459,
    -0.000003262662348117,
    -0.000003009758748271,
    -0.000002742033619678,
    -0.000002463115291641,
    -0.000002176607055184,
    -0.000001886037893705,
    -0.000001594816664615,
    -0.000001306190289856,
    -0.000001023206421189,
    -0.000000748680952383,
    -0.000000485170652772,
    -0.000000234951100831,
    0.000000000000000019,
    0.000000218014132615,
    0.000000417738002653,
    0.000000598134480256,
    0.000000758478702482,
    0.000000898349659197,
    0.000001017617644516,
    0.000001116428004295,
    0.000001195181650636,
    0.000001254512842746,
    0.000001295264753823,
    0.000001318463351782,
    0.000001325290122058,
    0.000001317054149878,
    0.000001295164062029,
    0.000001261100300474,
    0.000001216388167899,
    0.000001162572044339,
    0.000001101191130664,
    0.000001033757024641,
    0.000000961733384918,
    0.000000886517883529,
    0.000000809426594851,
    0.000000731680913777,
    0.000000654397044918,
    0.000000578578053248,
    0.000000505108421313,
    0.000000434751013771,
    0.000000368146313112,
    0.000000305813755894,
    0.000000248154972516,
    0.000000195458710256,
    0.000000147907204499,
    0.000000105583751622,
    0.000000068481234050,
    0.000000036511347694,
    0.000000009514289665,
    -0.000000012731325998,
    -0.000000030498540123,
    -0.000000044102305546,
    -0.000000053890104103,
    -0.000000060233074770,
    -0.000000063517776804,
    -0.000000064138686005,
    -0.000000062491493702,
    -0.000000058967252182,
    -0.000000053947383292,
    -0.000000047799543644,
    -0.000000040874316652,
    -0.000000033502683005,
    -0.000000025994203151,
    -0.000000018635833070,
    -0.000000011691283219,
    -0.000000005400824840,
    0.000000000018556635,
    0.000000004372760117,
    0.000000007490016135,
    0.000000009220272356,
    0.000000009434599049,
    0.000000008024683804,
    0.000000004902472754
};

static float samples[N+SYFALA_BLOCK_NSAMPLES];
static float sawtooth;

static void read_input_samples() {
	mem_rd:
    for (int n = 0; n < SYFALA_BLOCK_NSAMPLES; n++) {
         samples[SYFALA_BLOCK_NSAMPLES-1-n] = sawtooth;
         sawtooth += 0.01f;
         sawtooth = sawtooth > 1 ? sawtooth -1 : sawtooth;
    }
}

static void compute_fir(float* fTemp) {
    outer_coef: for (int i = 0; i < N; i++) {
        inner_sample: for (int n = 0; n < SYFALA_BLOCK_NSAMPLES; n++) {
            fTemp[n] += samples[i+SYFALA_BLOCK_NSAMPLES-1-n] * coeffs[i];
        }
    }
}

static void circular_buffer() {
    for (int j = N+SYFALA_BLOCK_NSAMPLES-1; j > SYFALA_BLOCK_NSAMPLES; --j) {
    	 samples[j] = samples[j-SYFALA_BLOCK_NSAMPLES];
    }
}

static void write_output_samples(sy_ap_int* audio_out_0, sy_ap_int* audio_out_1, float* fTemp) {
    for (int n = 0; n < SYFALA_BLOCK_NSAMPLES; n++) {
        iowritef(fTemp[n], &audio_out_0[n]);
        iowritef(fTemp[n], &audio_out_1[n]);
    }
}

void compute(sy_ap_int* audio_out_0, sy_ap_int* audio_out_1) {
    float fTemp[SYFALA_BLOCK_NSAMPLES]={0};
    read_input_samples();
    circular_buffer();
    compute_fir(fTemp);
    write_output_samples(audio_out_0,audio_out_1,fTemp);
}

void syfala (
		sy_ap_int* audio_out_0,
		sy_ap_int* audio_out_1,
           int arm_ok,
            bool* i2s_rst,
        float* mem_zone_f,
          int* mem_zone_i,
          bool bypass,
          bool mute,
          bool debug
){
#pragma HLS INTERFACE s_axilite port=arm_ok
#pragma HLS INTERFACE m_axi port=mem_zone_f latency=30 bundle=ram
#pragma HLS INTERFACE m_axi port=mem_zone_i latency=30 bundle=ram
#pragma HLS INTERFACE ap_fifo port=audio_out_0
#pragma HLS INTERFACE ap_fifo port=audio_out_1
    // Active high reset, this HAVE TO BE DONE FIRST (crash with *some* dsp if not)
    *i2s_rst = !arm_ok;
    /* Initialization and computations can start after the ARM
     * has been initialized */
    if (arm_ok) {
        /* First function call: initialization */
        if (initialization) {
        // Initialize all runtime data here.
        // don't forget to toggle the variable off
           initialization = false;
        } else {
            /* ... or compute samples here
             * if you need to convert to float, use the following:
             * (audio inputs and outputs are 24-bit integers) */
            compute(audio_out_0, audio_out_1);
        }
    } else {
    /* Waiting for the ARM to be ready,
     * just output zeroes meanwhile... */
    }
}

